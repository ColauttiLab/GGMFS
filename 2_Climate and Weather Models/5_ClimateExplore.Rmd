---
title: "ClimateExplore"
author: "GGMFS Team"
date: "21/04/2021"
output: html_document
---

This script explores and maps climatic variation, focusing on WorldClim bioclim variables.
NOTE: download bioclim data from climond.org; data in ERSI grids can be used with 'raster' in R. These should be saved in a new folder called: "../climond_data".

## Data prep and function load

```{r}
library(maptools)
library(rgbif)
library(dismo)
library(rgdal)
library(ggplot2)
library(tidyr)

## Load custom Functions

# Climate maps
source("../Functions/climapper.R")
# Basic PCA of bioclim variables
source("../Functions/bioPCA.R")


## Data import and setup

## Import the raster files
## NB: This 'files' command has to match the file directory for the bioclim data
Files <- list.files(path=paste(getwd(),"../climond_data/CM10_1975H_Bio_ESRI_V12",sep="/"),pattern='w001001.adf', recursive=TRUE,full.names=TRUE )

#Stacking raster files
Predictors <- stack(Files)

names(Predictors)<-paste0("bio",c(1:length(names(Predictors))))
### NB: Bio36-40 are first 5 PCs of the other bioclim variables

## Import data from gbif.org (or load if already present)
if(!file.exists("../GBIF_Locations.csv")){  
  ApKey<-name_suggest(q='Alliaria petiolata', rank='species')[[1]]
  ApKey<-ApKey$key[1]
  
  ApData<-occ_search(taxonKey=ApKey,limit=100000)
  write.csv(ApData$data,"../GBIF_Locations.csv",row.names=F)
}

# Extract lat/long coordinates from GBIF search
ApLocs<-read.csv("../GBIF_Locations.csv")[,c("decimalLatitude","decimalLongitude")]
AllRecs<-data.frame(Latitude=ApLocs$decimalLatitude,Longitude=ApLocs$decimalLongitude,Region=NA)


# Add region info for later graphing

# Europe, western Asia and Middle East
AllRecs$Region[AllRecs$Longitude > -35 & AllRecs$Longitude < 50]<-"Europe" 
# North American Longitudes
AllRecs$Region[AllRecs$Longitude < -35 & AllRecs$Longitude  > -168]<-"NorthAm"

# Exclude tropics and southern hemisphere
AllRecs<-AllRecs[AllRecs$Latitude > 26,] 

# Remove coordinates with any missing data.
AllRecs<-AllRecs[complete.cases(AllRecs),]

# Check that locations are only in North America and Europe
qplot(AllRecs$Longitude,AllRecs$Latitude)+ylim(-90,90)+xlim(-180,180) 

# Import GGMFS data
PopMeans<-read.csv("../Population_Means.csv", header=T) 

# Remove populations with missing longitude and latitude data
PopMeans<-PopMeans %>% drop_na(Longitude)

```

## Plot the worldclim data and GM sample points
```{r}
# Plot map with bioclim overlay

#Creating small dataframe of location data
AllSites<-AllRecs[,c("Longitude","Latitude")]

##
#PLOTTING
##
#Run all code below in chunk together. 

# NB: Need wide, narrow plot window to get best pic
plot(Predictors$bio36,xlim=c(-125,45),ylim=c(30,60),1,main="",xaxt="n",yaxt="n",legend=F) 
#GBIF pop locations  
points(AllSites, col="#F4007633", cex=0.1,pch=16) 
# add very slight random noise to better see points that are really close together
PopLocsRnd<-PopMeans[,c("Longitude","Latitude")]+runif(382,-0.2,0.2) 
points(PopLocsRnd, col="#003F91FF", cex=1.5,pch=21) #GGMFS pop locations
points(PopLocsRnd, col="#98B9F266", cex=1,pch=16) #GGMFS pop locations 


```


## Extract data from bioclim variables
```{r}
### Extract bioclim data from PopLocs locations
PresVals <- extract(Predictors, PopMeans[,c("Longitude","Latitude")])
DistVals <- extract(Predictors, AllRecs[,c("Longitude","Latitude")])

# Problem: Data not available for a few locations
NoDat<-!complete.cases(PresVals)

# In these cases, average of closest locations within 100KM
PresVals[NoDat,]<-extract(Predictors, PopMeans[NoDat,c("Longitude","Latitude")],buffer=100000,fun=mean)


```


## Plot populations in climate space
```{r}
### GGMFS SAMPLE POPULATIONS

#MErging GGMFS data with climate data
PlotData<-cbind(PopMeans,data.frame(PresVals))

## Perform Basic PCA of climate data and add PC data to dataframe
PlotData<-cbind(PlotData,bioPCA(PlotData))

### GBIF OCCURRENCE DATA
PlotDist<-cbind(AllRecs,data.frame(DistVals))
PlotDist<-PlotDist[complete.cases(PlotDist),]
# Add PCs 
PlotDist<-cbind(PlotDist,bioPCA(PlotDist))


### Base plot
p <- ggplot() + xlab("PC1") + ylab("PC2") + theme_classic(base_size=48) + guides(fill=FALSE)
# Optional: Add Convex hulls
#p <- p + geom_polygon(data = ConvHullNat,aes(x=PC1,y=PC2),fill="#4FB0C666", alpha = 0.2)
#p <- p + geom_polygon(data = ConvHullInt,aes(x=PC1,y=PC2),fill="#F5375166", alpha = 0.2)

### Plot for field survey locations
p1 <- p + geom_point(data=PlotData[PlotData$Region=="Europe",],aes(x=PC1,y=PC2),colour="#4FB0C633",size=8,shape=16) 
p1 <- p1 + geom_point(data=PlotData[PlotData$Region=="Europe",],aes(x=PC1,y=PC2),colour="#4FB0C6FF",size=8,shape=1) 
p1 <- p1 + geom_point(data=PlotData[PlotData$Region=="NorthAm",],aes(x=PC1,y=PC2),colour="#F5375133",size=8,shape=16)
p1 <- p1 + geom_point(data=PlotData[PlotData$Region=="NorthAm",],aes(x=PC1,y=PC2),colour="#F53751FF",size=8,shape=1)
png("../DataExplore/Climates_ByPop.png",width=21,height=14,units="in",res=200)
  p1
dev.off()

### Plot for GBIF records
p2 <- p + geom_point(data=PlotDist[PlotDist$Region=="Europe",],aes(x=PC1,y=PC2),colour="#4FB0C633",size=3,shape=1)
p2 <- p2 + geom_point(data=PlotDist[PlotDist$Region=="NorthAm",],aes(x=PC1,y=PC2),colour="#F5375133",size=3,shape=1)
png("../DataExplore/Climates_DistOnly.png",width=21,height=14,units="in",res=200)
  p2
dev.off()
```


## Climate Maps
```{r}
### Make Map Directory if needed
dir.create("../Maps", showWarnings = FALSE)
# Map output to new window for immediate inspection
climapper(Type="png",Locs=T,Borders=T)
#!# Climate graphs with different options # NOTE: These are saved directly to "Maps" folder
climapper(Type="png")
climapper(Type="png",Borders=T)
climapper(Type="png",Locs=T)
climapper(Type="png",Borders=T,Locs=T)
climapper(Type="png",Borders=T,Locs=T,AllLocs=T)
```


### Output data with bioclim variables
```{r}
PopData<-merge(PopMeans,PlotData[,grep("bio|Pop_Code",names(PlotData))],by="Pop_Code")
write.csv(PopData,"../Population_Means_wClimate.csv", row.names=FALSE) 
```


